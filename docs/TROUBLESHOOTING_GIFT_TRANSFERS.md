# Устранение проблем с передачей подарков

## Частые ошибки и их причины

### 1. Failed to transfer unique gift (msg_id=XXXXXX)

**Возможные причины:**

#### a) Подарок еще нельзя передавать
- Уникальные подарки имеют период ожидания перед передачей (обычно 24 часа)
- Проверьте атрибут `can_transfer_at` - если он больше текущего времени, подарок нельзя передать
- **Решение:** Подождите указанное время

#### b) Недостаточно Stars на балансе
- Для передачи каждого уникального подарка требуется **15 Stars**
- **Решение:** Пополните баланс Stars или продайте ненужные подарки

#### c) Проблемы с API Telegram
- Rate limiting (слишком много запросов)
- Временная недоступность API
- **Решение:** Добавлена задержка 1 секунда между передачами. При повторных ошибках увеличьте задержку

#### d) Неверный получатель
- Указан несуществующий или заблокировавший бота user_id
- **Решение:** Проверьте константу `RECIPIENT_USER_ID` в коде

#### e) Ошибки Telegram API
Типичные ошибки:
- `STARGIFT_TRANSFER_FORBIDDEN` - подарок нельзя передать (не уникальный или еще не готов)
- `USER_ID_INVALID` - неверный ID получателя
- `FLOOD_WAIT_X` - нужно подождать X секунд перед следующим запросом
- `STARS_INSUFFICIENT` - недостаточно Stars

### 2. Failed to send regular gift: Gift #XXXXXX

**Возможные причины:**

#### a) Недостаточно Stars
- У вас недостаточно Stars для покупки подарка
- **Решение:** Проверьте баланс перед покупкой

#### b) Проблемы с платежной формой
- Telegram API не вернул form_id
- Невалидный form_id
- **Решение:** Теперь в логах будет показана конкретная ошибка

#### c) Rate limiting
- Слишком много покупок за короткое время
- **Решение:** Добавлена задержка 2 секунды между покупками

#### d) Ошибки Telegram API
Типичные ошибки:
- `PAYMENT_UNSUPPORTED` - метод оплаты не поддерживается
- `INVOICE_INVALID` - невалидный инвойс для подарка
- `FLOOD_WAIT_X` - нужно подождать X секунд

## Улучшения в коде

### 1. Детальные логи ошибок
Теперь функции `transfer_unique_gift` и `buy_and_send_regular_gift` выводят:
- Тип исключения
- Текст ошибки
- Контекст (msg_id, gift_title)

### 2. Дополнительная информация в логах
- Время до возможности передачи подарка
- Попытки отправки подарков логируются перед выполнением
- Больше контекста при ошибках

### 3. Задержки между операциями
- 1 секунда между передачами уникальных подарков
- 2 секунды между отправками обычных подарков
- 10 секунд между проверками баланса при ожидании

## Как читать логи

```
[AUTO-TRANSFER] [INFO] Attempting to transfer gift (msg_id=186731)...
[ERROR] Failed to transfer gift (msg_id=186731): RpcError: STARGIFT_TRANSFER_FORBIDDEN
[AUTO-TRANSFER] [ERROR] Failed to transfer unique gift (msg_id=186731)
```

В этом примере:
1. Система пытается передать подарок с msg_id=186731
2. Telegram API вернул ошибку `STARGIFT_TRANSFER_FORBIDDEN`
3. Подарок нельзя передать (возможно, еще не прошел период ожидания)

## Рекомендации

1. **Мониторьте баланс Stars** перед запуском автоматической передачи
2. **Проверяйте, что подарки готовы к передаче** (прошел период `can_transfer_at`)
3. **Не запускайте несколько процессов передачи одновременно** - это приведет к rate limiting
4. **Проверяйте логи** на наличие конкретных ошибок API
5. **При FLOOD_WAIT ошибках** подождите указанное время перед повторной попыткой

## Константы в коде

```python
# ID получателя подарков (измените при необходимости)
RECIPIENT_USER_ID = 8316993133

# Задержки
BALANCE_CHECK_INTERVAL = 10  # секунд между проверками баланса
MAX_BALANCE_WAIT_TIME = 300  # максимальное время ожидания баланса
```

## Дополнительная отладка

Для получения еще более подробных логов можно временно добавить вывод исключений:

```python
except Exception as e:
    import traceback
    print(f"[ERROR] Full traceback:")
    traceback.print_exc()
    print(f"[ERROR] Failed to transfer gift (msg_id={msg_id}): {type(e).__name__}: {str(e)}")
    return False
```
